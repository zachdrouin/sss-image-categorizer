{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card mb-4">
            <div class="card-header">
                <h4><i class="fas fa-images me-2"></i>Process Images</h4>
            </div>
            <div class="card-body">
                {% if not has_api_key %}
                    <div class="alert alert-warning">
                        <strong><i class="fas fa-exclamation-triangle me-2"></i>Warning:</strong> No API key set. Please go to <a href="/settings">Settings</a> to set your OpenAI API key.
                    </div>
                {% endif %}
                
                <form action="/process" method="post">
                    <div class="row">
                        <!-- Left Column: File Selection and Options -->
                        <div class="col-md-6">
                            <!-- File Selection Section -->
                            <div class="mb-4">
                                <label for="input_file" class="form-label"><i class="fas fa-file-csv me-2"></i>Input CSV File:</label>
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control" id="input_file" name="input_file" value="{{ config.get('last_input_file', '') }}" required>
                                    <button type="button" class="btn btn-secondary" id="browse_input_btn"><i class="fas fa-folder-open"></i></button>
                                </div>
                                <div class="form-text">Select the CSV file containing image URLs to categorize</div>
                            </div>
                            
                            <div class="mb-4">
                                <label for="output_file" class="form-label"><i class="fas fa-file-export me-2"></i>Output CSV File:</label>
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control" id="output_file" name="output_file" value="{{ config.get('last_output_file', '') }}">
                                    <button type="button" class="btn btn-secondary" id="browse_output_btn"><i class="fas fa-folder-open"></i></button>
                                </div>
                                <div class="form-text">Where to save the categorized results</div>
                            </div>
                            
                            <!-- Processing Options -->
                            <div class="card mb-4">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0"><i class="fas fa-sliders-h me-2"></i>Processing Options</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="batch_size" class="form-label"><i class="fas fa-layer-group me-2"></i>Batch Size:</label>
                                        <input type="number" class="form-control" id="batch_size" name="batch_size" value="{{ config.get('batch_size', 5) }}" min="1" max="20">
                                        <div class="form-text">Number of images to process at once</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="start_row" class="form-label"><i class="fas fa-step-forward me-2"></i>Start Row:</label>
                                        <input type="number" class="form-control" id="start_row" name="start_row" value="{{ config.get('start_row', 0) }}" min="0">
                                        <div class="form-text">Skip rows at the beginning of the CSV</div>
                                    </div>
                                    
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="mock_mode" name="mock_mode">
                                        <label class="form-check-label" for="mock_mode">
                                            <i class="fas fa-vial me-2"></i>Mock Mode (No API calls)
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Right Column: Category Selection -->
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0"><i class="fas fa-tags me-2"></i>Select Categories to Apply to All Images</h5>
                                </div>
                                <div class="card-body">
                                    <p class="mb-3">Click on categories to select them. <span id="selected_count" class="badge bg-primary">0</span> categories selected.</p>
                                    
                                    <div class="category-selections">
                                        <!-- Main Categories -->
                                        {% if categories.main %}
                                        <div class="category-group">
                                            <h6 class="category-group-title"><i class="fas fa-star me-2"></i>Main Categories</h6>
                                            <div>
                                                {% for category in categories.main %}
                                                <span class="category-badge" data-category="{{ category }}">{{ category.split(' > ')[-1] }}</span>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        {% endif %}
                                        
                                        <!-- Colors -->
                                        {% if categories.colors %}
                                        <div class="category-group">
                                            <h6 class="category-group-title"><i class="fas fa-palette me-2"></i>Colors</h6>
                                            <div>
                                                {% for category in categories.colors %}
                                                <span class="category-badge" data-category="{{ category }}">{{ category.split(' > ')[-1] }}</span>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        {% endif %}
                                        
                                        <!-- People -->
                                        {% if categories.people %}
                                        <div class="category-group">
                                            <h6 class="category-group-title"><i class="fas fa-user me-2"></i>People</h6>
                                            <div>
                                                {% for category in categories.people %}
                                                <span class="category-badge" data-category="{{ category }}">{{ category.split(' > ')[-1] }}</span>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        {% endif %}
                                        
                                        <!-- Orientation -->
                                        {% if categories.orientation %}
                                        <div class="category-group">
                                            <h6 class="category-group-title"><i class="fas fa-crop-alt me-2"></i>Orientation</h6>
                                            <div>
                                                {% for category in categories.orientation %}
                                                <span class="category-badge" data-category="{{ category }}">{{ category.split(' > ')[-1] }}</span>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        {% endif %}
                                        
                                        <!-- Mockups -->
                                        {% if categories.mockups %}
                                        <div class="category-group">
                                            <h6 class="category-group-title"><i class="fas fa-object-group me-2"></i>Mockups</h6>
                                            <div>
                                                {% for category in categories.mockups %}
                                                <span class="category-badge" data-category="{{ category }}">{{ category.split(' > ')[-1] }}</span>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        {% endif %}
                                        
                                        <!-- Copy Space -->
                                        {% if categories.copy_space %}
                                        <div class="category-group">
                                            <h6 class="category-group-title"><i class="fas fa-align-left me-2"></i>Copy Space</h6>
                                            <div>
                                                {% for category in categories.copy_space %}
                                                <span class="category-badge" data-category="{{ category }}">{{ category.split(' > ')[-1] }}</span>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Hidden input to store selected categories -->
                                    <input type="hidden" name="selected_categories" id="selected_categories" value="">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="d-grid gap-2 col-md-6 mx-auto">
                        <button type="submit" class="btn btn-primary btn-lg" id="start_btn">
                            <i class="fas fa-play me-2"></i>Start Processing
                        </button>
                        <button type="button" class="btn btn-danger btn-lg" id="stop_btn" style="display: none;">
                            <i class="fas fa-stop me-2"></i>Stop Processing
                        </button>
                        <button type="button" class="btn btn-success btn-lg" id="complete_btn" style="display: none;">
                            <i class="fas fa-check-circle me-2"></i>Processing Complete!
                        </button>
                    </div>
                    
                    <!-- Hidden input to track active tab -->
                    <input type="hidden" name="active_tab" id="active_tab" value="home">
                </form>
                
                <div class="progress-container mt-4">
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                    </div>
                    <p id="progress_message" class="mt-2 text-center"></p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // Browse buttons functionality
        $('#browse_input_btn').click(function() {
            $.get('/browse?type=input', function(data) {
                if (data.path) {
                    $('#input_file').val(data.path);
                }
            });
        });
        
        $('#browse_output_btn').click(function() {
            $.get('/browse?type=output', function(data) {
                if (data.path) {
                    $('#output_file').val(data.path);
                }
            });
        });
        
        // Category selection functionality
        $('.category-badge').click(function() {
            $(this).toggleClass('selected');
            updateSelectedCategories();
        });
        
        function updateSelectedCategories() {
            var selected = [];
            $('.category-badge.selected').each(function() {
                selected.push($(this).data('category'));
            });
            $('#selected_categories').val(JSON.stringify(selected));
            $('#selected_count').text(selected.length);
        }
        
        // Stop button functionality
        $('#stop_btn').click(function() {
            $.get('/stop', function() {
                $('#stop_btn').prop('disabled', true).text('Stopping...');
            });
        });
        
        // Complete button functionality
        $('#complete_btn').click(function() {
            $('.progress-container').hide();
            $('#complete_btn').hide();
            $('#start_btn').show();
        });
        
        // Check progress periodically
        function checkProgress() {
            $.getJSON('/progress', function(data) {
                if (data.total > 0) {
                    var percent = Math.round((data.current / data.total) * 100);
                    $('.progress-bar').css('width', percent + '%').attr('aria-valuenow', percent).text(percent + '%');
                    
                    // Format message with appropriate icon
                    var icon = data.success ? 'fa-check-circle' : 'fa-info-circle';
                    $('#progress_message').html('<i class="fas ' + icon + ' me-2"></i>' + data.message);
                    $('.progress-container').show();
                    
                    // Show/hide buttons based on completion
                    if (data.complete) {
                        $('#start_btn').hide();
                        $('#stop_btn').hide();
                        $('#complete_btn').show();
                        
                        // Add appropriate class to progress bar when complete
                        if (data.success) {
                            $('.progress-bar').removeClass('bg-primary').addClass('bg-success');
                            $('#progress_message').addClass('text-success').removeClass('text-danger');
                        } else {
                            $('.progress-bar').removeClass('bg-primary').addClass('bg-danger');
                            $('#progress_message').addClass('text-danger').removeClass('text-success');
                        }
                    } else {
                        $('#start_btn').hide();
                        $('#stop_btn').show();
                        $('#complete_btn').hide();
                    }
                }
            });
        }
        
        setInterval(checkProgress, 2000);
        checkProgress(); // Check immediately on page load
        
        // Store current page in session storage to preserve context
        sessionStorage.setItem('lastPage', window.location.pathname);
        
        // Add event listeners to nav links to store the active tab
        $('.nav-link').on('click', function() {
            sessionStorage.setItem('activeTab', $(this).attr('href'));
        });
    });
</script>
{% endblock %}
